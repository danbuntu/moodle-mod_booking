{"version":3,"file":"dynamicoptiondateform.min.js","sources":["../src/dynamicoptiondateform.js"],"sourcesContent":["/* eslint-disable promise/always-return */\n/* eslint-disable promise/catch-or-return */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    mod_booking\n * @copyright  2022 Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport DynamicForm from 'core_form/dynamicform';\nimport ModalForm from 'core_form/modalform';\nimport Templates from 'core/templates';\nimport {exception as displayException} from 'core/notification';\n\nconst optiondateForm = new DynamicForm(document.querySelector('#optiondates-form'), 'mod_booking\\\\form\\\\dynamicoptiondateform');\n\nexport const initdynamicoptiondateform = (cmid, bookingid, optionid, modalTitle, formClass) => {\n\n    optiondateForm.load({\n        'cmid': cmid,\n        'bookingid': bookingid,\n        'optionid': optionid,\n        'modalTitle': modalTitle,\n        'formClass': formClass\n    })\n    .then(() => {\n        datelistinit();\n        initmodaloptiondateform(modalTitle, formClass);\n        return;\n    })\n    // Deal with this exception (Using core/notify exception function is recommended).\n    .catch(ex => displayException(ex));\n\n    optiondateForm.addEventListener(optiondateForm.events.SERVER_VALIDATION_ERROR, () => {\n        datelistinit();\n        initmodaloptiondateform(modalTitle, formClass);\n        return;\n    });\n\n    optiondateForm.addEventListener(optiondateForm.events.FORM_SUBMITTED, (e) => {\n\n        // Remember values when form gets submitted.\n        var chooseperiodvalue = document.querySelector('[name=\"chooseperiod\"]').value;\n        var reoccurringdatestringvalue = document.querySelector('[name=\"reoccurringdatestring\"]').value;\n\n        // It is recommended to reload the form after submission because the elements may change.\n        // This will also remove previous submission errors. You will need to pass the same arguments to the form\n        // that you passed when you rendered the form on the page.\n        optiondateForm.load({\n            'cmid': cmid,\n            'bookingid': bookingid,\n            'optionid': optionid,\n            'modalTitle': modalTitle,\n            'formClass': formClass\n        })\n        .then(() => {\n            // Only do this, if it's not a blocked event.\n            /* if (!reoccurringdatestringvalue.trim().toLowerCase().includes('block')) {} */\n\n            e.preventDefault();\n            const response = e.detail;\n\n            Templates.renderForPromise('mod_booking/bookingoption_dates', // eslint-disable-line promise/no-nesting\n                response)\n            // It returns a promise that needs to be resolved.\n            .then(({html, js}) => {\n\n                Templates.replaceNodeContents('.optiondates-list', html, js);\n\n                return;\n            })\n            // Deal with this exception (Using core/notify exception function is recommended).\n            .catch(ex => displayException(ex));\n\n            var oldlists = document.getElementsByClassName('optiondates-list');\n            while (oldlists.length > 1) {\n                oldlists[oldlists.length - 1].parentNode.removeChild(oldlists[oldlists.length - 1]);\n            }\n\n            // This is needed to fix datelist bugs.\n            datelistinit();\n\n            // We need this, so we don't lose the form data after reloading.\n            document.querySelector('[name=\"chooseperiod\"]').value = chooseperiodvalue;\n            document.querySelector('[name=\"reoccurringdatestring\"]').value = reoccurringdatestringvalue;\n            // Also load the data into the hidden elements which we need to pass the values to the non-dynamic form.\n            document.querySelector('#semesterid').value = chooseperiodvalue;\n            document.querySelector('#dayofweektime').value = reoccurringdatestringvalue;\n\n            // Initialize modal again.\n            initmodaloptiondateform(modalTitle, formClass);\n\n            return;\n        })\n        // Deal with this exception (Using core/notify exception function is recommended).\n        .catch(ex => displayException(ex));\n    });\n};\n\nexport const datelistinit = () => {\n\n    var dateform = document.querySelector(\"#optiondates-form\");\n    var datelist = document.querySelector(\".optiondates-list\");\n\n    datelist.parentNode.removeChild(datelist);\n    // Important: Move datelist after dateform so $_POST will work in PHP.\n    dateform.parentNode.insertBefore(datelist, dateform.nextSibling);\n\n    datelist.addEventListener('click', function(e) {\n\n        let action = e.target.dataset.action;\n        let targetid = e.target.dataset.targetid;\n\n        if (action === 'delete') {\n            e.target.closest('li').remove();\n            document.getElementById(targetid).remove();\n        }\n\n        if (action === 'add') {\n            let targetElement = e.target.closest('li');\n            let date = document.querySelector(\"#meeting-time\");\n            let element = '<li><span class=\"badge bg-primary\">' + date.value +\n                '</span> <i class=\"fa fa-trash ml-2 icon-red\" data-action=\"delete\"></i></li>';\n            targetElement.insertAdjacentHTML('afterend', element);\n        }\n    });\n\n    // Add an event listener to the chooseperiod autocomplete to store semesterid in a hidden input field.\n    // We need this, so we can save it later via $_POST from the not dynamic moodle form.\n    document.querySelector('[name=\"chooseperiod\"]').addEventListener('change', (e) => {\n        document.querySelector('#semesterid').value = e.target.value;\n    });\n\n    waitForElm('input[name=\"reoccurringdatestring\"]').then((stringelm) => {\n        const submitbutton = document.querySelector('#optiondates-form input[name=\"submitbutton\"]');\n        if (stringelm.value.trim().toLowerCase().includes('block')) {\n            submitbutton.style.display = 'none'; // Hide the button.\n        } else {\n            submitbutton.style.display = 'block'; // Show the button.\n        }\n    });\n\n    // Add an event listener to the reoccurring datestring to store it in a hidden input field.\n    // We need this, so we can save it later via $_POST from the not dynamic moodle form.\n    const reoccurringdatestring = document.querySelector('input[name=\"reoccurringdatestring\"]');\n    reoccurringdatestring.addEventListener('keyup', (e) => {\n        const submitbutton = document.querySelector('#optiondates-form input[name=\"submitbutton\"]');\n        if (e.target.value.trim().toLowerCase().includes('block')) {\n            submitbutton.style.display = 'none'; // Hide the button.\n        } else {\n            submitbutton.style.display = 'block'; // Show the button.\n        }\n        document.querySelector('#dayofweektime').value = e.target.value;\n    });\n};\n\nexport const initmodaloptiondateform = (modalTitle, formClass) => {\n    waitForElm('button[name=\"customdatesbtn\"]').then((customdatesbtn) => {\n        customdatesbtn.addEventListener('click', (e) => {\n            e.preventDefault();\n            const modalform = new ModalForm({\n                formClass,\n                modalConfig: {title: modalTitle},\n                returnFocus: e.currentTarget\n            });\n            // If necessary extend functionality by overriding class methods, for example:\n            modalform.addEventListener(modalform.events.FORM_SUBMITTED, (e) => {\n                const response = e.detail;\n                const tname1 = 'mod_booking/bookingoption_dates_custom_list_items';\n                Templates.renderForPromise(tname1, // eslint-disable-line promise/no-nesting\n                    response)\n                // It returns a promise that needs to be resolved.\n                .then(({html, js}) => {\n                    Templates.appendNodeContents('ul.reoccurringdates', html, js);\n                    return;\n                })\n                // Deal with this exception (Using core/notify exception function is recommended).\n                .catch(ex => displayException(ex));\n\n                const tname2 = 'mod_booking/bookingoption_dates_custom_hidden_inputs';\n                Templates.renderForPromise(tname2, // eslint-disable-line promise/no-nesting\n                     response)\n                // It returns a promise that needs to be resolved.\n                .then(({html, js}) => {\n                    Templates.appendNodeContents('div.optiondates-list', html, js);\n                    return;\n                })\n                // Deal with this exception (Using core/notify exception function is recommended).\n                .catch(ex => displayException(ex));\n            });\n            // Show the modal.\n            modalform.show();\n        });\n    });\n};\n\n/**\n * Wait until a certain element is loaded.\n * @param {string} selector - The element selector.\n * @returns {Promise}\n */\n function waitForElm(selector) {\n    // eslint-disable-next-line consistent-return\n    return new Promise(resolve => {\n        if (document.querySelector(selector)) {\n            return resolve(document.querySelector(selector));\n        }\n        const observer = new MutationObserver(() => {\n            if (document.querySelector(selector)) {\n                resolve(document.querySelector(selector));\n                observer.disconnect();\n            }\n        });\n        observer.observe(document.body, {\n            childList: true,\n            subtree: true\n        });\n    });\n}\n"],"names":["_interopRequireDefault","obj","__esModule","default","_dynamicform","_modalform","_templates","optiondateForm","DynamicForm","document","querySelector","_exports","initdynamicoptiondateform","cmid","bookingid","optionid","modalTitle","formClass","load","then","datelistinit","initmodaloptiondateform","catch","ex","displayException","exception","addEventListener","events","SERVER_VALIDATION_ERROR","FORM_SUBMITTED","e","chooseperiodvalue","value","reoccurringdatestringvalue","preventDefault","response","detail","Templates","renderForPromise","_ref","html","js","replaceNodeContents","oldlists","getElementsByClassName","length","parentNode","removeChild","dateform","datelist","insertBefore","nextSibling","action","target","dataset","targetid","closest","remove","getElementById","targetElement","element","insertAdjacentHTML","waitForElm","stringelm","submitbutton","trim","toLowerCase","includes","style","display","customdatesbtn","modalform","ModalForm","modalConfig","title","returnFocus","currentTarget","_ref2","appendNodeContents","_ref3","show","selector","Promise","resolve","observer","MutationObserver","disconnect","observe","body","childList","subtree"],"mappings":"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"}